name: Deploy RaspServer to Pi

on:
  push:
    branches: [main, develop]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write Firebase credentials (JSON)
        shell: bash
        env:
          FIREBASE_KEY_JSON: ${{ secrets.FIREBASE_KEY_JSON }}
        run: |
          set -euo pipefail
          if [ -z "${FIREBASE_KEY_JSON:-}" ]; then
            echo "❌ FIREBASE_KEY_JSON secret is empty or not set"
            exit 1
          fi

          printf '%s' "$FIREBASE_KEY_JSON" > firebase-key.json

          test -s firebase-key.json
          python3 -c "import json; json.load(open('firebase-key.json','r',encoding='utf-8')); print('✅ firebase-key.json is valid JSON')"

      - name: Deploy and restart service
        shell: bash
        run: |
          set -euo pipefail

          echo "Pulling latest code..."
          git fetch origin
          git reset --hard origin/main

          echo "Deploying firebase-key.json..."
          sudo install -m 600 firebase-key.json /home/monkphx/harvestpilot-raspserver/firebase-key.json

          echo "Restarting service..."
          sudo systemctl restart harvestpilot-raspserver

          sleep 2
          if sudo systemctl is-active --quiet harvestpilot-raspserver; then
            echo "✅ Service running successfully"
          else
            echo "❌ Service failed to start"
            sudo systemctl status harvestpilot-raspserver --no-pager || true
            echo "---- last 120 lines of logs ----"
            sudo journalctl -u harvestpilot-raspserver -n 120 --no-pager || true
            exit 1
          fi
