# Device ID Linking Architecture - Explained

## ðŸ”— Three-Tier Device ID System

Your HarvestPilot now has **three levels of device identification** that work together:

### TIER 1: Raspberry Pi Hardware Serial (Unique Per Device)

```
Physical Pi Hardware
â”œâ”€â”€ Serial Number: 10000000abcdef01
â”œâ”€â”€ MAC Address: B8:27:EB:12:34:56
â””â”€â”€ CPU ID: (from /proc/cpuinfo)

âœ… PERMANENT - Never changes
âœ… HARDWARE BOUND - Identifies the physical Pi
âœ… UNIQUE - Every Pi has different serial
```

**Retrieved from:**
```bash
# Get Pi Serial
cat /proc/cpuinfo | grep Serial

# Get MAC Address
cat /sys/class/net/eth0/address
```

---

### TIER 2: Configuration Device ID (Human Readable)

```
config.py
â”œâ”€â”€ DEVICE_ID = os.getenv("DEVICE_ID", "raspserver-001")
â””â”€â”€ Current value: "raspserver-001"

âœ… CONFIGURABLE - Can be changed
âœ… HUMAN READABLE - Easy to identify
âœ… PER-ENVIRONMENT - Different for rack-a, rack-b, etc.
```

**Set via:**
```bash
# On Raspberry Pi (in systemd service or .env)
export DEVICE_ID=raspserver-001

# Or in code
DEVICE_ID = "rack-a-pi-1"
```

---

### TIER 3: Firebase Device ID (Cloud Identifier)

```
Firebase Database
â””â”€â”€ hp-XXXXXXXX (auto-generated)

âœ… AUTO-GENERATED - Created on first registration
âœ… UNIQUE IN CLOUD - Identifies device in Firebase
âœ… PERMANENT - Linked to hardware and config
```

**Generated by:**
```python
# In device_manager.py
unique_suffix = str(uuid.uuid4())[:8].upper()
firebase_id = f"hp-{unique_suffix}"
# Example: hp-A7B2C9E1
```

---

## ðŸ”— How They Link Together

### Registration Flow

```
1. Pi boots up
   â†“
2. config.py loads
   DEVICE_ID = "raspserver-001" (TIER 2)
   â†“
3. RaspServer.__init__() creates DeviceManager
   device_manager = DeviceManager(device_id="raspserver-001")
   â†“
4. DeviceManager._get_pi_serial()
   Reads: /proc/cpuinfo
   Finds: "10000000abcdef01" (TIER 1)
   â†“
5. DeviceManager._get_pi_mac()
   Reads: /sys/class/net/eth0/address
   Finds: "B8:27:EB:12:34:56" (TIER 1)
   â†“
6. server.start() calls device_manager.register_device()
   â†“
7. DeviceManager generates Firebase ID
   firebase_id = "hp-A7B2C9E1" (TIER 3)
   â†“
8. All three IDs written to Firebase:
   {
     "hardware_serial": "10000000abcdef01",      (TIER 1)
     "mac_address": "B8:27:EB:12:34:56",         (TIER 1)
     "config_device_id": "raspserver-001",       (TIER 2)
     "device_id": "hp-A7B2C9E1",                 (TIER 3)
     "device_mapping": {...}                     (LINKS)
   }
   â†“
9. Firebase path created:
   /devices/hp-A7B2C9E1/
   â†“
10. Webapp sends commands to:
    /devices/hp-A7B2C9E1/commands/
    â†“
11. Pi listens and responds
```

---

## ðŸ“‹ Firebase Registration Example

After integration, device registers in Firebase like this:

```
devices/
â””â”€â”€ hp-A7B2C9E1/
    â”œâ”€â”€ device_id: "hp-A7B2C9E1"
    â”œâ”€â”€ config_device_id: "raspserver-001"
    â”œâ”€â”€ hardware_serial: "10000000abcdef01"
    â”œâ”€â”€ mac_address: "B8:27:EB:12:34:56"
    â”‚
    â”œâ”€â”€ device_mapping: {
    â”‚   "hardware_serial": "10000000abcdef01",
    â”‚   "hardware_mac": "B8:27:EB:12:34:56",
    â”‚   "config_id": "raspserver-001",
    â”‚   "firebase_id": "hp-A7B2C9E1",
    â”‚   "linked_at": "2026-01-25T20:30:00.123456"
    â”‚}
    â”‚
    â”œâ”€â”€ hardware: {
    â”‚   "model": "Raspberry Pi 4B",
    â”‚   "serial": "10000000abcdef01",
    â”‚   "mac": "B8:27:EB:12:34:56",
    â”‚   "gpio_pins": {...},
    â”‚   "pwm_frequency": {...}
    â”‚}
    â”‚
    â”œâ”€â”€ status: "online"
    â”œâ”€â”€ registered_at: "2026-01-25T20:30:00.123456"
    â”œâ”€â”€ platform: "raspberry_pi"
    â”‚
    â”œâ”€â”€ commands/
    â”‚   â””â”€â”€ cmd-001: {...}
    â”‚
    â”œâ”€â”€ responses/
    â”‚   â””â”€â”€ cmd-001: {...}
    â”‚
    â””â”€â”€ telemetry/
        â””â”€â”€ {...}
```

---

## ðŸŽ¯ Use Cases for Each ID

### Use TIER 1 (Hardware Serial)
- **Physical asset tracking** - Track which Pi is where
- **Hardware warranty** - Link to warranty info
- **Inventory management** - Identify Pi when swapping
- **Prevent duplicates** - Ensure each Pi only registers once

### Use TIER 2 (Config ID)
- **User-friendly identification** - Easy to say "rack-a-pi-1"
- **Environment separation** - Different IDs for dev/staging/prod
- **Configuration per-unit** - Each Pi gets custom settings
- **Logging & debugging** - Human-readable logs

### Use TIER 3 (Firebase ID)
- **Cloud identification** - Reference in database queries
- **API calls** - Send commands using this ID
- **Web app display** - Show user a short ID
- **Cross-device communication** - Link multiple devices

---

## ðŸ” How to Find Your Device IDs

### Get TIER 1 (Hardware Serial)

```bash
# SSH to your Pi
ssh monkphx@192.168.1.233

# Get Serial
cat /proc/cpuinfo | grep Serial
# Output: Serial        : 10000000abcdef01

# Get MAC
cat /sys/class/net/eth0/address
# Output: b8:27:eb:12:34:56
```

### Get TIER 2 (Config ID)

```bash
# Check config
grep DEVICE_ID ~/harvestpilot-raspserver/config.py
# Output: DEVICE_ID = os.getenv("DEVICE_ID", "raspserver-001")

# Check environment variable
echo $DEVICE_ID
# Output: raspserver-001
```

### Get TIER 3 (Firebase ID)

After integration, check logs:
```bash
sudo journalctl -u harvestpilot-raspserver -n 5
# Look for: Device registered successfully: hp-XXXXXXXX
```

Or check Firebase Console:
1. Go to: https://console.firebase.google.com
2. Select: harvest-hub
3. Realtime Database
4. Look at: devices/ folder
5. Find your device: hp-XXXXXXXX/

---

## ðŸ”§ How to Map Multiple Pis

If you have multiple Raspberry Pis:

```
Pi #1: Rack-A
â”œâ”€â”€ TIER 1 (Hardware): 10000000abcdef01
â”œâ”€â”€ TIER 2 (Config): "rack-a-pi-1"
â””â”€â”€ TIER 3 (Firebase): hp-A7B2C9E1

Pi #2: Rack-B
â”œâ”€â”€ TIER 1 (Hardware): 10000000xyz12345
â”œâ”€â”€ TIER 2 (Config): "rack-b-pi-2"
â””â”€â”€ TIER 3 (Firebase): hp-F5D8E3X2

Pi #3: Backup
â”œâ”€â”€ TIER 1 (Hardware): 10000000newserial
â”œâ”€â”€ TIER 2 (Config): "backup-pi"
â””â”€â”€ TIER 3 (Firebase): hp-K9M2L7R4
```

**In Firebase:**
```
devices/
â”œâ”€â”€ hp-A7B2C9E1/
â”‚   â”œâ”€â”€ config_device_id: "rack-a-pi-1"
â”‚   â”œâ”€â”€ hardware_serial: "10000000abcdef01"
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ hp-F5D8E3X2/
â”‚   â”œâ”€â”€ config_device_id: "rack-b-pi-2"
â”‚   â”œâ”€â”€ hardware_serial: "10000000xyz12345"
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ hp-K9M2L7R4/
    â”œâ”€â”€ config_device_id: "backup-pi"
    â”œâ”€â”€ hardware_serial: "10000000newserial"
    â””â”€â”€ ...
```

**In Webapp:**
```javascript
// Query by Firebase ID (TIER 3)
const device = await firebase
  .database()
  .ref('devices/hp-A7B2C9E1')
  .once('value');

// Find by config ID (TIER 2)
const allDevices = await firebase
  .database()
  .ref('devices')
  .once('value');

const rackADevice = Object.entries(allDevices.val())
  .find(([_, data]) => data.config_device_id === 'rack-a-pi-1');
```

---

## ðŸ“Š Summary Table

| Aspect | TIER 1 (Hardware) | TIER 2 (Config) | TIER 3 (Firebase) |
|--------|-------------------|-----------------|-------------------|
| **Value** | 10000000abcdef01 | raspserver-001 | hp-A7B2C9E1 |
| **Format** | Hex string | Human readable | hp-XXXXXXXX |
| **Origin** | /proc/cpuinfo | config.py | Auto-generated |
| **Mutable** | No | Yes | No (after creation) |
| **Scope** | Physical device | Installation | Cloud database |
| **Use case** | Asset tracking | User ID | API reference |
| **Uniqueness** | Globally unique | Local | Cloud unique |

---

## âœ… What Was Updated

Your `device_manager.py` now:

1. **Reads Pi Serial** - Calls `_get_pi_serial()`
2. **Reads Pi MAC** - Calls `_get_pi_mac()`
3. **Gets Config ID** - Reads from `config.DEVICE_ID`
4. **Creates Firebase ID** - Generates `hp-XXXXXXXX`
5. **Links All Three** - In `device_mapping` field
6. **Registers in Firebase** - Stores all IDs together

---

## ðŸŽ¯ Next Steps

1. âœ… Updated device_manager.py (done)
2. ðŸ”² Integrate into main.py (follow INTEGRATION_VISUAL_GUIDE.md)
3. ðŸ”² Restart service
4. ðŸ”² Check Firebase to verify all three IDs registered
5. ðŸ”² Test commands using Firebase ID

---

## ðŸ“š See Also

- [INTEGRATION_VISUAL_GUIDE.md](INTEGRATION_VISUAL_GUIDE.md) - How to integrate
- [CODE_STRUCTURE_ANALYSIS.md](CODE_STRUCTURE_ANALYSIS.md) - Architecture overview
- [docs/FIREBASE_CONTROL_INTEGRATION.md](docs/FIREBASE_CONTROL_INTEGRATION.md) - Complete reference
