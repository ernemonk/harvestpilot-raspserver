name: Deploy RaspServer to Pi

on:
  push:
    branches: [main, develop]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write Firebase credentials (workspace)
        shell: bash
        env:
          FIREBASE_KEY_JSON: ${{ secrets.FIREBASE_KEY_JSON }}
        run: |
          set -euo pipefail
          test -n "${FIREBASE_KEY_JSON:-}"
          printf '%s' "$FIREBASE_KEY_JSON" > firebase-key.json
          test -s firebase-key.json
          python3 -c "import json; json.load(open('firebase-key.json','r',encoding='utf-8')); print('✅ firebase-key.json valid')"

      - name: Deploy and restart service
        shell: bash
        run: |
          set -euo pipefail

          echo "Pulling latest code..."
          git fetch origin
          git reset --hard origin/main

          echo "Deploying firebase-key.json..."
          sudo install -m 600 firebase-key.json /home/monkphx/harvestpilot-raspserver/firebase-key.json

          echo "Restarting service..."
          if ! sudo systemctl restart harvestpilot-raspserver; then
            echo "❌ restart command failed"
            sudo systemctl status harvestpilot-raspserver --no-pager || true
            sudo journalctl -u harvestpilot-raspserver -n 200 --no-pager || true
            exit 3
          fi

          sleep 2
          if sudo systemctl is-active --quiet harvestpilot-raspserver; then
            echo "✅ Service running successfully"
          else
            echo "❌ Service not active after restart"
            sudo systemctl status harvestpilot-raspserver --no-pager || true
            sudo journalctl -u harvestpilot-raspserver -n 200 --no-pager || true
            exit 3
          fi
