name: Deploy RaspServer to Pi

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Firebase Credentials
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${FIREBASE_KEY_JSON:-}" ]; then
            echo "Creating firebase-key.json from secret..."
            cat > firebase-key.json << 'EOF'
${{ secrets.FIREBASE_KEY_JSON }}
EOF
            test -s firebase-key.json && echo "✓ Firebase credentials configured ($(wc -c < firebase-key.json) bytes)" || (echo "✗ Failed to create firebase-key.json"; exit 1)
          else
            echo "✗ FIREBASE_KEY_JSON secret is not set"
            exit 1
          fi
      
      - name: Deploy to Raspberry Pi
        run: |
          # Pull latest code
          echo "Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          # Copy firebase-key.json if it was created
          if [ -f "firebase-key.json" ]; then
            cp firebase-key.json /home/monkphx/harvestpilot-raspserver/firebase-key.json
            chmod 600 /home/monkphx/harvestpilot-raspserver/firebase-key.json
            echo "✓ Firebase credentials deployed"
          fi
          
          # Note: pip3 is broken on system, dependencies already installed
          # Skip pip install - use apt to install new system dependencies if needed
          echo "✓ Code updated successfully"
          
          # Restart service
          echo "Restarting service..."
          sudo systemctl restart harvestpilot-raspserver || sudo systemctl start harvestpilot-raspserver
          
          # Verify service is running
          sleep 2
          if sudo systemctl is-active --quiet harvestpilot-raspserver; then
              echo "✓ Service running successfully"
          else
              echo "✗ Service failed to start"
              sudo systemctl status harvestpilot-raspserver
              exit 1
          fi
      
      - name: Deployment Status
        if: success()
        run: echo "✓ RaspServer deployed successfully to Pi"
      
      - name: Deployment Failed
        if: failure()
        run: |
          echo "✗ Deployment to Pi failed"
          exit 1
