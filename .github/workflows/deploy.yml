name: Deploy RaspServer to Pi

on:
  push:
    branches: [main, develop]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write Firebase credentials (workspace)
        shell: bash
        env:
          FIREBASE_KEY_JSON: ${{ secrets.FIREBASE_KEY_JSON }}
        run: |
          set -euo pipefail
          test -n "${FIREBASE_KEY_JSON:-}"
          printf '%s' "$FIREBASE_KEY_JSON" > firebase-key.json
          test -s firebase-key.json
          python3 -c "import json; json.load(open('firebase-key.json','r',encoding='utf-8')); print('‚úÖ firebase-key.json valid')"

      - name: Setup GPIO configuration
        shell: bash
        env:
          PI_MODEL: ${{ secrets.PI_MODEL || 'pi4' }}
          MODULE_ID: ${{ secrets.MODULE_ID || '' }}
          PUMP_GPIO: ${{ secrets.PUMP_GPIO || '17' }}
          LIGHT_GPIO: ${{ secrets.LIGHT_GPIO || '18' }}
          DHT_GPIO: ${{ secrets.DHT_GPIO || '4' }}
          WATER_GPIO: ${{ secrets.WATER_GPIO || '27' }}
        run: |
          set -euo pipefail
          echo "üîß Setting up GPIO configuration..."
          bash src/scripts/setup-gpio-automated.sh

      - name: Initialize Pi and register to Firestore
        shell: bash
        env:
          FIREBASE_CREDENTIALS_PATH: /home/monkphx/harvestpilot-raspserver/firebase-key.json
        run: |
          set -euo pipefail
          echo "üìù Initializing Pi and registering to Firestore..."
          
          # Make sure init script is executable
          chmod +x src/scripts/server_init.py
          
          # Run initialization (this will also be called by systemd on service start)
          python3 src/scripts/server_init.py || {
            echo "‚ö†Ô∏è  Init script failed, but service will attempt to start"
            # Don't exit here - allow service to start even if registration fails
          }

      - name: Deploy and restart service
        shell: bash
        run: |
          set -euo pipefail

          echo "Pulling latest code..."
          git fetch origin
          git reset --hard origin/main

          echo "Deploying firebase-key.json..."
          sudo install -m 600 -o monkphx -g monkphx firebase-key.json /home/monkphx/harvestpilot-raspserver/firebase-key.json

          echo "Restarting service..."
          if ! sudo systemctl restart harvestpilot-raspserver; then
            echo "‚ùå restart command failed"
            sudo systemctl status harvestpilot-raspserver --no-pager || true
            sudo journalctl -u harvestpilot-raspserver -n 200 --no-pager || true
            exit 3
          fi

          sleep 2
          if sudo systemctl is-active --quiet harvestpilot-raspserver; then
            echo "‚úÖ Service running successfully"
          else
            echo "‚ùå Service not active after restart"
            sudo systemctl status harvestpilot-raspserver --no-pager || true
            sudo journalctl -u harvestpilot-raspserver -n 200 --no-pager || true
            exit 3
          fi
